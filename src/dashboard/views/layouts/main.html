<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/assets/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=SUSE:wght@100..800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/file-explorer.css" />
  <title>Cute Magick</title>

  <link rel="icon" type="image/png" href="/img/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-title" content="Cute Magick">
  <link rel="manifest" href="/img/site.webmanifest">
</head>
<body class="flex-col lg:h-svh justify-between flex text-gray-900 dark:text-white">
  <header class="w-full bottom-0">
    <div class="font-semibold p-4 w-full inline-flex large:text-lg gap-4 lg:gap-6 justify-between items-center">
      <nav class="inline-flex text-sm lg:text-base items-center gap-4 lg:gap-6">
        <button
        hx-on:click="
          let nameOrUrl = prompt('Enter site name (or Git repo URL):');
          if (!nameOrUrl) return;

          const gitUrlRegex = /^(git@[\w.-]+:[\w./~-]+\.git|https?:\/\/[\w.-]+\/[\w./~-]+\.git)$/;

          if (nameOrUrl.startsWith('http://') || nameOrUrl.startsWith('https://')) {
            nameOrUrl = prompt('Enter an SSH URL');
            if (!gitUrlRegex.test(nameOrUrl)) {
              alert('Invalid Git URL');
              return;
            }
          }

          if (!nameOrUrl) return;
          htmx.ajax('POST', '/sites', {
            values: { nameOrUrl },
            swap: 'none'
          });
        "
        class="btn py-1! rainbow-tiler border-0! lg:px-4! text-black!">New Site</button>
      </nav>
      <nav class="inline-flex text-sm lg:text-base gap-4 lg:gap-6">
        <div
          class="cursor-pointer select-none"
          data-action="copy-key"
        >
          üîå Connect
        </div>
        <button onclick="if (confirm('Ready to log out?')) {
          htmx.ajax('POST', '/account/logout');
          setTimeout(() => {}, 0);
        }">üö™ Log Out</button>
      </nav>
    </div>
  </header>
  {{{body}}}
  <main id="windows">
  </main>
  <div class="bg-subtle-rainbow fixed w-full h-full inset-0 -z-1"></div>
  <!-- <div class="opacity-10 bg-cover bg-center fixed w-full h-full inset-0 -z-1" style="background-image: url(https://bookmarks.magick.host/_next/image?url=%2Fapi%2Fassets%2F302a2116-a55c-4d66-8e16-48a6a2e35a9a&w=1920&q=75)"></div> -->
  <script src="/js/events.js"></script>
  <script src="https://unpkg.com/popper.js@1"></script>
  <script src="https://unpkg.com/tippy.js@5"></script>
  <script src="/js/htmx.min.js"></script>
  <script src="/js/DraggableWindows.js" defer></script>
  <script src="/js/file-explorer.js" defer></script>
  <script src="/js/mount-file-explorer.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
  <script src="/js/mount-code-editor.js"></script>
  <script src="/js/save-file.js"></script>

  <script>
    function initTippy(root = document) {
      if (!window.tippy) return;

      root.querySelectorAll('[data-tippy-content]').forEach(el => {
        if (!el._tippy) {
          tippy(el, {
            placement: 'bottom'
          });
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initTippy();
    });

    document.body.addEventListener('htmx:afterSwap', (e) => {
      initTippy(e.target);
    });
  </script>

<script>
  function forceCopy(text) {
    const input = document.createElement('input');
    input.value = text;

    // Make it focusable & invisible
    input.style.position = 'fixed';
    input.style.top = '-1000px';
    input.style.left = '-1000px';

    document.body.appendChild(input);

    input.focus();
    input.select();
    input.setSelectionRange(0, input.value.length);

    const success = document.execCommand('copy');
    document.body.removeChild(input);

    return success;
  }

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();

    const action = btn.dataset.action;

    try {
      if (action === 'copy-key') {
        if (!confirm('Copy your public SSH key to your clipboard?')) return;
        const res = await fetch('/connect/public-key', {
          method: 'POST',
        });

        if (!res.ok) throw new Error('Failed to fetch key');

        const key = await res.text();

        // üîë THE IMPORTANT PART
        const copied = forceCopy(key);

        if (!copied) {
          alert('Copy failed. Please copy manually:\n\n' + key);
          return;
        }

        alert('Your public SSH key has been copied to your clipboard!');
      }
    } catch (err) {
      console.error(err);
      alert('Something went wrong. Please try again.');
    }
  });
</script>
<script>
document.addEventListener('click', function(e) {
  const tab = e.target.closest('[data-tab]');
  if (tab) {
    // Remove data-active from all tabs in this window
    tab.closest('.window').querySelectorAll('[data-tab]').forEach(el => {
      delete el.dataset.active;
    });
    
    // Set active on clicked tab after HTMX processes
    setTimeout(() => {
      tab.dataset.active = 'true';
    }, 0);
  }
});
</script>
<script>
(function () {
  console.log('[TimeMachine] script loaded');

  document.addEventListener('click', async (e) => {
    console.log('[TimeMachine] click event', e.target);

    const btn = e.target.closest('button[data-history-action]');
    console.log('[TimeMachine] closest button[data-history-action]:', btn);

    if (!btn) return;

    const action = btn.dataset.historyAction;
    const commit = btn.dataset.commit;

    console.log('[TimeMachine] action:', action);
    console.log('[TimeMachine] commit:', commit);

    // üîí Resolve site from the nearest owner that declares it
    const windowEl = btn.closest('.window');
    console.log('[TimeMachine] closest .window:', windowEl);

    const siteUuid = windowEl?.id;
    console.log('[TimeMachine] resolved siteUuid:', siteUuid);

    const siteDir = windowEl?.dataset.siteDirectory;
    console.log('[TimeMachine] resolved siteUuid:', siteDir);

    if (!siteUuid) {
      console.warn('[TimeMachine] abort: no site UUID found');
      return;
    }

    /* ----------------------------
       üëÄ Preview arbitrary commit
    ----------------------------- */
if (action === 'preview') {
  console.log('[TimeMachine] PREVIEW ‚Üí POST in new tab');

  const site = siteDir;        // window.id
  const path = 'index.html';    // default
  const previewUrl = `/preview/${site}/${commit}`;

  console.log('[TimeMachine] previewUrl:', previewUrl);
  console.log('[TimeMachine] commit:', commit);

  // Create a temporary form
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = previewUrl;
  form.target = '_blank';

  // Commit input
  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'commit';
  input.value = commit;

  form.appendChild(input);
  document.body.appendChild(form);

  form.submit();
  document.body.removeChild(form);

  return;
}


    /* ----------------------------
       üåç Return to live
    ----------------------------- */
    if (action === 'preview-live') {
      console.log('[TimeMachine] PREVIEW-LIVE action triggered');

      const url = new URL(location.href);
      url.hash = '';

      console.log('[TimeMachine] reloading live URL:', url.toString());
      location.reload();
      return;
    }

    /* ----------------------------
       ‚è™ Restore as draft (ignored for now)
    ----------------------------- */
    if (action === 'restore-draft') {
      console.log('[TimeMachine] restore-draft clicked (ignored for preview debugging)');
      return;
    }

    console.warn('[TimeMachine] unknown action:', action);
  });
})();
</script>

</body>
</html>